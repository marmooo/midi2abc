function fixIllegalDuration(a,c,d,e,b){const f=e.error;if(f!=0){let g="";if(e.numerator/e.denominator>1){const j=60,k=a[0].startTime,l=a[0].endTime,m=j*e.numerator/e.denominator/d,h=a[0].startTime+m;a.forEach(a=>{a.startTime=h});const i=chordToString(a,c,d);a.forEach(a=>{a.startTime=k,a.endTime=h}),i==""?a.forEach(a=>a.tie=!1):a.forEach(a=>a.tie=!0);const n=chordToString(a,null,d);return a.forEach(a=>{a.endTime=l}),b=round(b,1e6),console.log(`illegal duration is rounded: ${b}, ${f}, ${g}`),n+i}if(c){const e=f/d;return a[0].endTime==c[0].startTime&&c.forEach(a=>a.startTime-=e),a.forEach(a=>a.endTime-=e),g+=chordToString(a,c,d),b=round(b,1e6),console.log(`illegal duration is rounded: ${b}, ${f}, ${g}`),g}}}function getTupletString(b,a){return tupletCount==0&&a.factor!=0?(tupletNum=a.denominator,tupletCount+=1,b):tupletCount<tupletNum?(tupletCount+=1,tupletCount==tupletNum&&(tupletCount=0,tupletNum=0),""):""}function noteToString(f,h,d){const b=f[0],g=noteToKeyString(b),e=(b.endTime-b.startTime)*d,a=approximateKeyLength(e);if(a.numerator==0)return"";const c=fixIllegalDuration(f,h,d,a,e);if(c)return c;const[i,j]=calcKeyLength(a),k=b.tie?"-":"",l=getTupletString(i,a);return l+g+j+k}function chordToString(a,d,c){if(a.length==1&&!a[0].splitted)return noteToString(a,d,c);const h=a.map(a=>{const b=a.tie?"-":"";return noteToKeyString(a)+b}).join(""),e=a[0],f=(e.endTime-e.startTime)*c,b=approximateKeyLength(f);if(b.numerator==0)return"";const g=fixIllegalDuration(a,d,c,b,f);if(g)return g;const[i,j]=calcKeyLength(b),k=getTupletString(i,b);return k+`[${h}]`+j}function noteToKeyString(f){const h=f.pitch,c=["C","^C","D","^D","E","F","^F","G","^G","A","^A","B"],d=h-60,e=d%12,a=Math.floor(d/12);if(a>=1){const d=a-1;let b=c.at(e).toLowerCase();for(let a=0;a<d;a++)b+="'";return b}const g=-a;let b=c.at(e);for(let a=0;a<g;a++)b+=",";return b}function cleanupTimeSignatures(c){const a=new Map;c.forEach(b=>{a.set(b.time,b)});const b=[];for(const[d,c]of a)b.push(c);return b}function cleanupTempos(d,b){const c=new Map;d.forEach(a=>{c.set(a.time,a.qpm)});const a=[];for(const[d,e]of c){const f={time:d,qpm:e,timeTo:b};a.push(f)}return a.length!=1&&(a.slice(0,-1).forEach((b,c)=>{b.timeTo=a[c+1].time}),a.at(-1).timeTo=b),a}function splitTempos(b,d,e){const c=[],a=cleanupTempos(d,e);return a.length==1?[[b,a[0]]]:(a.forEach((d,e)=>{const f=d.time,g=d.timeTo,h=b.filter(a=>a.startTime<g).filter(a=>f<=a.startTime);c.push([h,a[e]])}),c)}function splitInstruments(a){let d=0,b=0;const c=[];return a.forEach((f,e)=>{f.instrument!=d&&(c.push(a.slice(b,e)),d+=1,b=e)}),c.push(a.slice(b)),c}class KeyLength{constructor(a,b,c,d){this.numerator=a,this.denominator=b,this.factor=c,this.error=d}}function calcKeyLength(d){const a=d.numerator,b=d.denominator,c=d.factor;return a==0?[null,null]:b==1?a==1?["",""]:["",`${a}`]:c==0?a==1?["",`/${b}`]:["",`${a}/${b}`]:c>0?c==1?[`(${b}:${a}`,""]:[`(${b}:${a}`,`/${c}`]:[`(${b}:${a}`,`${-c}`]}function approximateKeyLength(b){const c=60;if(b=Math.round(b*1e6)/1e6,b==c)return new KeyLength(1,1,0,0);if(b<=0)return console.error(`duration is negative: ${b}`),new KeyLength(0,0,0,b);if(b*8<c)return console.log(`duration (less than z/8) is ignored: ${b}`),new KeyLength(0,0,0,b);let a=2;if(b>c){while(b/a>c)a*=2;if(b/a==c)return new KeyLength(a,1,0,0);a/=2;let f=b/a-c,d=a,e=1;for(let g=2;g<=16;g*=2){const j=2*g-1,h=a*j/g,i=round(b/h,1e6)-c;if(i==0)return h==Math.round(h)?new KeyLength(h,1,0,0):new KeyLength(a*j,g,0,0);else 0<i&&i<f&&(f=i,d=a*j,e=g)}for(a*=2;a>=1;a/=2)for(const d of[3,5,7])for(let e=1;e<=d-1;e++)if(b/a*d/e==c)return new KeyLength(e,d,-a,0);const g=b-c*d/e;return new KeyLength(d,e,0,g)}while(b*a<c)a*=2;if(b*a==c)return new KeyLength(1,a,0,0);let f=b*a-c,d=1,e=a;for(let g=2;g<=16;g*=2){const i=2*g-1,h=i/(a*g),j=Math.abs(round(b/h,1e6)-c);if(j==0)return h==Math.round(h)?new KeyLength(h,1,0,0):new KeyLength(i,a*g,0,0);else j<f&&(f=j,d=i,e=a*g)}for(;a>=1;a/=2)for(const d of[3,5,7])for(let e=1;e<=d-1;e++)if(b*a*d/e==c)return new KeyLength(e,d,a,0);const g=b-c*d/e;return new KeyLength(d,e,0,g)}function splitRestDurtion(a){const c=60;if(a=Math.round(a*1e6)/1e6,a<=c)return[a];const b=[];while(a>60){let d=2;while(a/d>c)d*=2;if(a/d==c)return b.push(a),b;const e=d*30;b.push(e),a-=e}return b.push(a),b}function durationToRestString(a,b,c){if(a<b){const e=(b-a)*c;let d="";return splitRestDurtion(e).forEach(c=>{const a=approximateKeyLength(c),[e,b]=calcKeyLength(a);if(b==null)return"";const f=getTupletString(e,a);d+=f+"z"+b}),d}return""}function guessClef(a){const b=a.reduce((a,b)=>a+b.pitch,0),c=b/a.length;return c>64?"G2":"F4"}function cleanupTime(b){let a=1/0;return b.notes.forEach(c=>{const b=c.startTime;b<a&&(a=b)}),a!=0&&(b.notes.forEach(b=>{b.startTime-=a,b.endTime-=a}),b.tempos.forEach(b=>{0<b.time&&(b.time-=a)}),b.totalTime-=a),b}function round(b,a){return Math.round(b*a)/a}function chordToTieString(b,c,d,e,g){let a="";const f=b[0].endTime;if(b.forEach(a=>a.endTime=sectionEnd),round(sectionEnd,1e13)==round(f,1e13))return b.forEach(a=>a.tie=!1),a+=chordToString(b,c,d),a+="|",section%4==0&&(a+="\n"),section+=1,sectionEnd=g.time+section*e,a;b.forEach(a=>a.tie=!0),a+=chordToString(b,c,d),a+="|";const h=Math.floor((f-b[0].startTime)/e);section%4==0&&(a+="\n");for(let k=1;k<h;k++){const i=section+1,j=g.time+i*e;if(b.forEach(a=>{a.startTime=sectionEnd,a.endTime=j}),round(j,1e13)==round(f,1e13))return b.forEach(a=>a.tie=!1),a+=chordToString(b,c,d),a+="|",i%4==0&&(a+="\n"),section=i,sectionEnd=j,a;b.forEach(a=>a.tie=!0),a+=chordToString(b,c,d),a+="|",i%4==0&&(a+="\n"),section=i,sectionEnd=j}return b.forEach(a=>{a.startTime=sectionEnd,a.endTime=f,a.tie=!1}),a+=chordToString(b,c,d),section+=1,sectionEnd=g.time+section*e,a}function durationToRestStrings(d,b,f,c,e){let a="";if(round(sectionEnd,1e13)<=round(b,1e13)){let g=sectionEnd;if(round(d,1e13)<round(sectionEnd,1e13)){a+=durationToRestString(d,sectionEnd,c),a+="|",section%4==0&&(a+="\n"),section+=1,sectionEnd=f.time+section*e;const h=Math.floor((b-g)/e);for(let b=0;b<h;b++)a+=durationToRestString(g,sectionEnd,c),a+="|",section%4==0&&(a+="\n"),section+=1,g=sectionEnd,sectionEnd=f.time+section*e;a+=durationToRestString(g,b,c)}else if(round(sectionEnd,1e13)==round(d,1e13)&&(a+="|",section%4==0&&(a+="\n"),section+=1,sectionEnd=f.time+section*e),round(b,1e13)<round(sectionEnd,1e13))a+=durationToRestString(d,b,c);else{a+=durationToRestString(d,sectionEnd,c),a+="|",section%4==0&&(a+="\n"),section+=1,g=sectionEnd,sectionEnd=section*e;const h=Math.floor((b-g)/e);for(let b=0;b<h;b++)a+=durationToRestString(g,sectionEnd,c),a+="|",section%4==0&&(a+="\n"),section+=1,g=sectionEnd,sectionEnd=f.time+section*e;a+=durationToRestString(g,b,c)}}else round(d,1e13)<round(b,1e13)&&(a+=durationToRestString(d,b,c));return a}function cloneNote(a){return{instrument:a.instrument,program:a.program,startTime:a.startTime,endTime:a.endTime,pitch:a.pitch,velocity:a.pitch,isDrum:a.isDrum}}function getTargetPosition(b,a){const c=b[a].endTime;for(a+=1;b[a]&&b[a].startTime<c;)a+=1;return a}function getNotationBreaks(c){const a=new Set;c.forEach(b=>{a.add(b.startTime),a.add(b.endTime)});const b=[...a];return b.sort((a,b)=>a>b?1:a<b?-1:0),b.slice(1)}function getChord(a){let b=0;const c=[];while(a[b]){const e=getTargetPosition(a,b),d=a.slice(b,e),f=getNotationBreaks(d);if(f.length==1)c.push(d),b=e;else{const g=a[b].endTime,h=f.filter(a=>a<=g),i=splitChord(d,h);c.push(...i);const j=d.filter(a=>g<a.endTime).map(b=>{const a=cloneNote(b);return a.startTime=g,a.splitted=!0,a});a=a.slice(e),a.unshift(...j),b=0}}return c}function splitChord(b,c){const a=[];return c.forEach((d,e)=>{if(e==0){const c=[],e=b[0].startTime;b.forEach(a=>{if(a.startTime==e){const b=cloneNote(a);b.endTime=d,b.splitted=!0,d<a.endTime&&(b.tie=!0),c.push(b)}}),a.push(c)}else{const f=c[e-1],g=[];b.forEach(a=>{if(a.startTime<=f&&d<=a.endTime){const b=cloneNote(a);b.startTime=f,b.endTime=d,b.splitted=!0,d<a.endTime&&(b.tie=!0),g.push(b)}}),a.push(g)}}),a.forEach(a=>{a.sort((a,b)=>a.tie==b.tie?0:a.tie?-1:1)}),a}function segmentToString(k,f,l,a){if(f.length==0)return"";const i=cleanupTimeSignatures(k.timeSignatures);let e=i.shift();const g=e.numerator/e.denominator,h=g<.75?2:4,c=a.qpm*h,d=240/a.qpm*g;let b=setInstrumentHeader(f,l,h,e);section=1,sectionEnd=a.time+section*d,e=i.shift();const j=getChord(f);return j.forEach((e,g)=>{const f=j[g+1];g==0&&e[0].startTime!=a.time&&(b+=durationToRestStrings(a.time,e[0].startTime,a,c,d)),round(sectionEnd,1e13)<round(e[0].endTime,1e13)?b+=chordToTieString(e,f,c,d,a):b+=chordToString(e,f,c),f?b+=durationToRestStrings(e[0].endTime,f[0].startTime,a,c,d):(b+=durationToRestStrings(e[0].endTime,a.timeTo,a,c,d),b.endsWith("\n")||(b+="\n"))}),b}function setInstrumentHeader(a,c,d,b){const e=b.numerator,f=b.denominator;return`L:1/${4*d}
M:${e}/${f}
K:C clef=${guessClef(a)}
V:${c+1}
%%MIDI program ${a[0].program}
`}let tupletNum=0,tupletCount=0,section,sectionEnd;export default function(a,b){console.log(a,a.tempos.length);let c="X:1\n";return b&&(b.title&&(c+=`T:${b.title}\n`),b.composer&&(c+=`C:${b.composer}\n`)),cleanupTime(a),splitTempos(a.notes,a.tempos,a.totalTime).forEach(([d,b])=>{c+=`Q:1/4=${Math.round(b.qpm)}\n`,splitInstruments(d).forEach((d,e)=>{section=0,c+=segmentToString(a,d,e,b)})}),c}