import tone2abc from"./midi2abc.js";function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleABCPanel(){document.getElementById("abcRow").classList.toggle("d-none"),document.getElementById("abcColumn").classList.toggle("d-none"),document.getElementById("abc").parentNode.parentNode.classList.toggle("row");const e=document.getElementById("abc");resizeABC(e)}function dropFileEvent(e){e.preventDefault();const t=e.dataTransfer.files[0],n=new DataTransfer;n.items.add(t);const s=document.getElementById("inputFile");s.files=n.files,convertFromBlob(t)}function convertFileEvent(e){convertFromBlob(e.target.files[0])}function convertUrlEvent(e){convertFromUrl(e.target.value)}async function convertFromUrlParams(){const e=new URLSearchParams(location.search);ns=await core.urlToNoteSequence(e.get("url")),nsCache=core.sequences.clone(ns),setToolbar(),convert(ns,e)}async function convertFromBlob(e,t){ns=await core.blobToNoteSequence(e),nsCache=core.sequences.clone(ns),setToolbar(),convert(ns,t)}async function convertFromUrl(e,t){ns=await core.urlToNoteSequence(e),nsCache=core.sequences.clone(ns),setToolbar(),convert(ns,t)}function setMIDIInfo(e){if(e instanceof URLSearchParams){const o=e.get("title"),i=e.get("composer"),t=e.get("maintainer"),n=e.get("web"),s=e.get("license");if(document.getElementById("midiTitle").textContent=o,document.getElementById("composer").textContent=i,n){const e=document.createElement("a");e.href=n,e.textContent=t,document.getElementById("maintainer").replaceChildren(e)}else document.getElementById("maintainer").textContent=t;try{new URL(s)}catch{document.getElementById("license").textContent=s}}else document.getElementById("midiTitle").textContent="",document.getElementById("composer").textContent="",document.getElementById("maintainer").textContent="",document.getElementById("license").textContent=""}function convert(e,t){setMIDIInfo(t);const n=tone2abc(e),s=document.getElementById("abc");s.value=n,resizeABC(s),initScore(n)}class CursorControl{constructor(e){this.root=e,this.cursor=this.initCursor(e)}initCursor(e){const t=document.createElementNS("http://www.w3.org/2000/svg","line");return t.setAttribute("class","abcjs-cursor"),t.setAttributeNS(null,"x1",0),t.setAttributeNS(null,"y1",0),t.setAttributeNS(null,"x2",0),t.setAttributeNS(null,"y2",0),e.appendChild(t),t}removeSelection(){const e=this.root.querySelectorAll(".abcjs-highlight");for(let t=0;t<e.length;t++)e[t].classList.remove("abcjs-highlight")}onStart(){}onEvent(e){if(e.measureStart&&e.left===null)return;this.removeSelection();for(let t=0;t<e.elements.length;t++){const n=e.elements[t];for(let e=0;e<n.length;e++)n[e].classList.add("abcjs-highlight")}this.cursor.setAttribute("x1",e.left-2),this.cursor.setAttribute("x2",e.left-2),this.cursor.setAttribute("y1",e.top),this.cursor.setAttribute("y2",e.top+e.height)}onFinished(){this.removeSelection(),this.cursor.setAttribute("x1",0),this.cursor.setAttribute("x2",0),this.cursor.setAttribute("y1",0),this.cursor.setAttribute("y2",0)}}function initScore(e){synthControl&&synthControl.pause();const n=document.getElementById("score"),s=document.getElementById("player"),o={responsive:"resize"},t=ABCJS.renderAbc("score",e,o);if(t[0].warnings)document.getElementById("abcWarning").innerHTML=t[0].warnings.join("<br>");else{document.getElementById("abcWarning").innerHTML="No errors";const e=new CursorControl(n.querySelector("svg"));if(ABCJS.synth.supportsAudio()){const n={displayLoop:!0,displayRestart:!0,displayPlay:!0,displayProgress:!0,displayWarp:!0,displayClock:!0};synthControl=new ABCJS.synth.SynthController,synthControl.load("#player",e,n);const s=new ABCJS.synth.CreateSynth;s.init({visualObj:t[0],options:{}}).then(()=>{synthControl.setTune(t[0],!0).then(()=>{const e=document.querySelector(".abcjs-inline-audio");e.classList.remove("disabled")})})}else s.innerHTML=`
  <div class="alert alert-warning">Audio is not supported on this browser.</div>
  `}}function initABCEditor(){const t={paper_id:"score",warnings_id:"abcWarning",abcjsParams:{responsive:"resize"}},e=document.getElementById("abc");e.value="",e.setAttribute("autocorrect","off"),new ABCJS.Editor("abc",t)}function getCheckboxString(e,t){return`
<div class="form-check form-check-inline">
  <label class="form-check-label">
    <input class="form-check-input" name="${e}" value="${t}" type="checkbox" checked>
    ${t}
  </label>
</div>`}function setInstrumentsCheckbox(){const t=new Set;ns.notes.forEach(e=>{t.add(e.instrument)});const e=new Map;let n="";t.forEach(t=>{n+=getCheckboxString("instrument",t),e.set(t,!0)});const o=(new DOMParser).parseFromString(n,"text/html"),s=document.getElementById("filterInstruments");s.replaceChildren(...o.body.childNodes),[...s.querySelectorAll("input")].forEach(t=>{t.addEventListener("change",n=>{const s=parseInt(t.value);n.currentTarget.checked?e.set(s,!0):e.set(s,!1),ns=core.sequences.clone(nsCache),ns.notes=ns.notes.filter(t=>e.get(t.instrument)),convert(ns)})})}function setProgramsCheckbox(){const t=new Set;ns.notes.forEach(e=>{t.add(e.program)});const e=new Map;let n="";t.forEach(t=>{n+=getCheckboxString("program",t),e.set(t,!0)});const o=(new DOMParser).parseFromString(n,"text/html"),s=document.getElementById("filterPrograms");s.replaceChildren(...o.body.childNodes),[...s.querySelectorAll("input")].forEach(t=>{t.addEventListener("change",n=>{const s=parseInt(t.value);n.currentTarget.checked?e.set(s,!0):e.set(s,!1),ns=core.sequences.clone(nsCache),ns.notes=ns.notes.filter(t=>e.get(t.program)),convert(ns)})})}function setToolbar(){setProgramsCheckbox(),setInstrumentsCheckbox()}function resizeABC(e){e.style.height=e.scrollHeight+4+"px"}function initQuery(){const e=new URLSearchParams;return e.set("title","When the Swallows Homeward Fly (Agathe)"),e.set("composer","Franz Wilhelm Abt"),e.set("maintainer","Stan Sanderson"),e.set("license","Public Domain"),e}loadConfig(),initABCEditor();let ns,nsCache,synthControl;if(location.search)convertFromUrlParams();else{const e=initQuery();convertFromUrl("abt.mid",e)}document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleABCPanel").onclick=toggleABCPanel,document.ondragover=e=>{e.preventDefault()},document.ondrop=dropFileEvent,document.getElementById("inputFile").onchange=convertFileEvent,document.getElementById("inputUrl").onchange=convertUrlEvent