function fixIllegalDuration(e,t,n,s,o){const i=s.error;if(i!=0){let a="";if(s.numerator/s.denominator>1){const l=60,d=e[0].startTime,u=e[0].endTime,h=l*s.numerator/s.denominator/n,r=e[0].startTime+h;e.forEach(e=>{e.startTime=r});const c=chordToString(e,t,n);e.forEach(e=>{e.startTime=d,e.endTime=r}),c==""?e.forEach(e=>e.tie=!1):e.forEach(e=>e.tie=!0);const m=chordToString(e,null,n);return e.forEach(e=>{e.endTime=u}),o=round(o,1e6),console.log(`illegal duration is rounded: ${o}, ${i}, ${a}`),m+c}if(t){const s=i/n;return e[0].endTime==t[0].startTime&&t.forEach(e=>e.startTime-=s),e.forEach(e=>e.endTime-=s),a+=chordToString(e,t,n),o=round(o,1e6),console.log(`illegal duration is rounded: ${o}, ${i}, ${a}`),a}}}function getTupletString(e,t){return tupletCount==0&&t.factor!=0?(tupletNum=t.denominator,tupletCount+=1,e):tupletCount<tupletNum?(tupletCount+=1,tupletCount==tupletNum&&(tupletCount=0,tupletNum=0),""):""}function noteToString(e,t,n){const s=e[0],r=noteToKeyString(s),i=(s.endTime-s.startTime)*n,o=approximateKeyLength(i);if(o.numerator==0)return"";const a=fixIllegalDuration(e,t,n,o,i);if(a)return a;const[c,l]=calcKeyLength(o),d=s.tie?"-":"",u=getTupletString(c,o);return u+r+l+d}function chordToString(e,t,n){if(e.length==1&&!e[0].splitted)return noteToString(e,t,n);const r=e.map(e=>{const t=e.tie?"-":"";return noteToKeyString(e)+t}).join(""),o=e[0],i=(o.endTime-o.startTime)*n,s=approximateKeyLength(i);if(s.numerator==0)return"";const a=fixIllegalDuration(e,t,n,s,i);if(a)return a;const[c,l]=calcKeyLength(s),d=getTupletString(c,s);return d+`[${r}]`+l}function noteToKeyString(e){const a=e.pitch,n=["C","^C","D","^D","E","F","^F","G","^G","A","^A","B"],s=a-60,o=s%12,t=Math.floor(s/12);if(t>=1){const s=t-1;let e=n.at(o).toLowerCase();for(let t=0;t<s;t++)e+="'";return e}const r=-t;let i=n.at(o);for(let e=0;e<r;e++)i+=",";return i}function cleanupTimeSignatures(e){const t=new Map;e.forEach(e=>{t.set(e.time,e)});const n=[];for(const[s,e]of t)n.push(e);return n}function cleanupTempos(e,t){const s=new Map;e.forEach(e=>{s.set(e.time,e.qpm)});const n=[];for(const[e,o]of s){const i={time:e,qpm:o,timeTo:t};n.push(i)}return n.length!=1&&(n.slice(0,-1).forEach((e,t)=>{e.timeTo=n[t+1].time}),n.at(-1).timeTo=t),n}function splitTempos(e,t,n){const o=[],s=cleanupTempos(t,n);return s.length==1?[[e,s[0]]]:(s.forEach((t,n)=>{const i=t.time,a=t.timeTo,r=e.filter(e=>e.startTime<a).filter(e=>i<=e.startTime);o.push([r,s[n]])}),o)}function splitInstruments(e){let s=0,t=0;const n=[];return e.forEach((o,i)=>{o.instrument!=s&&(n.push(e.slice(t,i)),s+=1,t=i)}),n.push(e.slice(t)),n}class KeyLength{constructor(e,t,n,s){this.numerator=e,this.denominator=t,this.factor=n,this.error=s}}function calcKeyLength(e){const t=e.numerator,n=e.denominator,s=e.factor;return t==0?[null,null]:n==1?t==1?["",""]:["",`${t}`]:s==0?t==1?["",`/${n}`]:["",`${t}/${n}`]:s>0?s==1?[`(${n}:${t}`,""]:[`(${n}:${t}`,`/${s}`]:[`(${n}:${t}`,`${-s}`]}function approximateKeyLength(e){const n=60;if(e=Math.round(e*1e6)/1e6,e==n)return new KeyLength(1,1,0,0);if(e<=0)return console.error(`duration is negative: ${e}`),new KeyLength(0,0,0,e);if(e*8<n)return console.log(`duration (less than z/8) is ignored: ${e}`),new KeyLength(0,0,0,e);let t=2;if(e>n){for(;e/t>n;)t*=2;if(e/t==n)return new KeyLength(t,1,0,0);t/=2;let i=e/t-n,s=t,o=1;for(let a=2;a<=16;a*=2){const l=2*a-1,r=t*l/a,c=round(e/r,1e6)-n;if(c==0)return r==Math.round(r)?new KeyLength(r,1,0,0):new KeyLength(t*l,a,0,0);else 0<c&&c<i&&(i=c,s=t*l,o=a)}for(t*=2;t>=1;t/=2)for(const s of[3,5,7])for(let o=1;o<=s-1;o++)if(e/t*s/o==n)return new KeyLength(o,s,-t,0);const a=e-n*s/o;return new KeyLength(s,o,0,a)}for(;e*t<n;)t*=2;if(e*t==n)return new KeyLength(1,t,0,0);let i=e*t-n,s=1,o=t;for(let a=2;a<=16;a*=2){const c=2*a-1,r=c/(t*a),l=Math.abs(round(e/r,1e6)-n);if(l==0)return r==Math.round(r)?new KeyLength(r,1,0,0):new KeyLength(c,t*a,0,0);else l<i&&(i=l,s=c,o=t*a)}for(;t>=1;t/=2)for(const s of[3,5,7])for(let o=1;o<=s-1;o++)if(e*t*s/o==n)return new KeyLength(o,s,t,0);const a=e-n*s/o;return new KeyLength(s,o,0,a)}function splitRestDurtion(e){const n=60;if(e=Math.round(e*1e6)/1e6,e<=n)return[e];const t=[];for(;e>60;){let s=2;for(;e/s>n;)s*=2;if(e/s==n)return t.push(e),t;const o=s*30;t.push(o),e-=o}return t.push(e),t}function durationToRestString(e,t,n){if(e<t){const o=(t-e)*n;let s="";return splitRestDurtion(o).forEach(e=>{const t=approximateKeyLength(e),[o,n]=calcKeyLength(t);if(n==null)return"";const i=getTupletString(o,t);s+=i+"z"+n}),s}return""}function guessClef(e){const t=e.reduce((e,t)=>e+t.pitch,0),n=t/e.length;return n>64?"G2":"F4"}function cleanupTime(e){let t=1/0;return e.notes.forEach(e=>{const n=e.startTime;n<t&&(t=n)}),t!=0&&(e.notes.forEach(e=>{e.startTime-=t,e.endTime-=t}),e.tempos.forEach(e=>{0<e.time&&(e.time-=t)}),e.totalTime-=t),e}function round(e,t){return Math.round(e*t)/t}function chordToTieString(e,t,n,s,o){let i="";const a=e[0].endTime;if(e.forEach(e=>e.endTime=sectionEnd),round(sectionEnd,1e13)==round(a,1e13))return e.forEach(e=>e.tie=!1),i+=chordToString(e,t,n),i+="|",section%4==0&&(i+=`
`),section+=1,sectionEnd=o.time+section*s,i;e.forEach(e=>e.tie=!0),i+=chordToString(e,t,n),i+="|";const r=Math.floor((a-e[0].startTime)/s);section%4==0&&(i+=`
`);for(let d=1;d<r;d++){const c=section+1,l=o.time+c*s;if(e.forEach(e=>{e.startTime=sectionEnd,e.endTime=l}),round(l,1e13)==round(a,1e13))return e.forEach(e=>e.tie=!1),i+=chordToString(e,t,n),i+="|",c%4==0&&(i+=`
`),section=c,sectionEnd=l,i;e.forEach(e=>e.tie=!0),i+=chordToString(e,t,n),i+="|",c%4==0&&(i+=`
`),section=c,sectionEnd=l}return e.forEach(e=>{e.startTime=sectionEnd,e.endTime=a,e.tie=!1}),i+=chordToString(e,t,n),section+=1,sectionEnd=o.time+section*s,i}function durationToRestStrings(e,t,n,s,o){let i="";if(round(sectionEnd,1e13)<=round(t,1e13)){let a=sectionEnd;if(round(e,1e13)<round(sectionEnd,1e13)){i+=durationToRestString(e,sectionEnd,s),i+="|",section%4==0&&(i+=`
`),section+=1,sectionEnd=n.time+section*o;const r=Math.floor((t-a)/o);for(let e=0;e<r;e++)i+=durationToRestString(a,sectionEnd,s),i+="|",section%4==0&&(i+=`
`),section+=1,a=sectionEnd,sectionEnd=n.time+section*o;i+=durationToRestString(a,t,s)}else if(round(sectionEnd,1e13)==round(e,1e13)&&(i+="|",section%4==0&&(i+=`
`),section+=1,sectionEnd=n.time+section*o),round(t,1e13)<round(sectionEnd,1e13))i+=durationToRestString(e,t,s);else{i+=durationToRestString(e,sectionEnd,s),i+="|",section%4==0&&(i+=`
`),section+=1,a=sectionEnd,sectionEnd=section*o;const r=Math.floor((t-a)/o);for(let e=0;e<r;e++)i+=durationToRestString(a,sectionEnd,s),i+="|",section%4==0&&(i+=`
`),section+=1,a=sectionEnd,sectionEnd=n.time+section*o;i+=durationToRestString(a,t,s)}}else round(e,1e13)<round(t,1e13)&&(i+=durationToRestString(e,t,s));return i}function cloneNote(e){return{instrument:e.instrument,program:e.program,startTime:e.startTime,endTime:e.endTime,pitch:e.pitch,velocity:e.pitch,isDrum:e.isDrum}}function getTargetPosition(e,t){const n=e[t].endTime;for(t+=1;e[t]&&e[t].startTime<n;)t+=1;return t}function getNotationBreaks(e){const t=new Set;e.forEach(e=>{t.add(e.startTime),t.add(e.endTime)});const n=[...t];return n.sort((e,t)=>e>t?1:e<t?-1:0),n.slice(1)}function getChord(e){let t=0;const n=[];for(;e[t];){const o=getTargetPosition(e,t),s=e.slice(t,o),i=getNotationBreaks(s);if(i.length==1)n.push(s),t=o;else{const a=e[t].endTime,r=i.filter(e=>e<=a),c=splitChord(s,r);n.push(...c);const l=s.filter(e=>a<e.endTime).map(e=>{const t=cloneNote(e);return t.startTime=a,t.splitted=!0,t});e=e.slice(o),e.unshift(...l),t=0}}return n}function splitChord(e,t){const n=[];return t.forEach((s,o)=>{if(o==0){const t=[],o=e[0].startTime;e.forEach(e=>{if(e.startTime==o){const n=cloneNote(e);n.endTime=s,n.splitted=!0,s<e.endTime&&(n.tie=!0),t.push(n)}}),n.push(t)}else{const i=t[o-1],a=[];e.forEach(e=>{if(e.startTime<=i&&s<=e.endTime){const t=cloneNote(e);t.startTime=i,t.endTime=s,t.splitted=!0,s<e.endTime&&(t.tie=!0),a.push(t)}}),n.push(a)}}),n.forEach(e=>{e.sort((e,t)=>e.tie==t.tie?0:e.tie?-1:1)}),n}function segmentToString(e,t,n,s){if(t.length==0)return"";const c=cleanupTimeSignatures(e.timeSignatures);let r=c.shift();const l=r.numerator/r.denominator,d=l<.75?2:4,i=s.qpm*d,a=240/s.qpm*l;let o=setInstrumentHeader(t,n,d,r);section=1,sectionEnd=s.time+section*a,r=c.shift();const u=getChord(t);return u.forEach((e,t)=>{const n=u[t+1];t==0&&e[0].startTime!=s.time&&(o+=durationToRestStrings(s.time,e[0].startTime,s,i,a)),round(sectionEnd,1e13)<round(e[0].endTime,1e13)?o+=chordToTieString(e,n,i,a,s):o+=chordToString(e,n,i),n?o+=durationToRestStrings(e[0].endTime,n[0].startTime,s,i,a):(o+=durationToRestStrings(e[0].endTime,s.timeTo,s,i,a),o.endsWith(`
`)||(o+=`
`))}),o}function setInstrumentHeader(e,t,n,s){const o=s.numerator,i=s.denominator;return`L:1/${4*n}
M:${o}/${i}
K:C clef=${guessClef(e)}
V:${t+1}
%%MIDI program ${e[0].program}
`}let tupletNum=0,tupletCount=0,section,sectionEnd;export default function(e,t){console.log(e,e.tempos.length);let n=`X:1
`;return t&&(t.title&&(n+=`T:${t.title}
`),t.composer&&(n+=`C:${t.composer}
`)),cleanupTime(e),splitTempos(e.notes,e.tempos,e.totalTime).forEach(([t,s])=>{n+=`Q:1/4=${Math.round(s.qpm)}
`,splitInstruments(t).forEach((t,o)=>{section=0,n+=segmentToString(e,t,o,s)})}),n}